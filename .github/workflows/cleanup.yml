# .github/workflows/cleanup-docker.yml
name: Cleanup Docker caches (free disk)

on:
  workflow_dispatch: {}
  workflow_call: {}  # allows reuse from other workflows

permissions: {}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Pre-clean diagnostics (disk + inodes)
      shell: bash
      run: |
        echo "===== DISK USAGE (df -h) ====="
        df -h
        echo
        echo "===== INODE USAGE (df -ih) ====="
        df -ih || true
        echo
        echo "===== Largest dirs in workspace (top 20) ====="
        du -x -h -d 2 "${GITHUB_WORKSPACE}" 2>/dev/null | sort -hr | head -n 20 || true
        echo
        echo "===== Largest dirs in /home/runner (top 20) ====="
        du -x -h -d 2 /home/runner 2>/dev/null | sort -hr | head -n 20 || true
        echo
        echo "===== Docker info (images/containers/volumes) ====="
        docker info || true
        docker images --digests --format 'table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}' || true
        docker ps -a --format 'table {{.Names}}\t{{.Status}}\t{{.Size}}' || true
        docker volume ls || true
        docker network ls || true

    - name: Stop Compose stacks (best-effort)
      shell: bash
      run: |
        set -e
        if command -v docker >/dev/null 2>&1; then
          echo "Bringing down docker-compose (best-effort)…"
          docker compose down --rmi local --volumes --remove-orphans || true
          # Some projects pin a project name—try again with explicit project detection
          if [ -f docker-compose.yml ] || [ -f compose.yml ]; then
            docker compose -p "${GITHUB_REPOSITORY##*/}" down --rmi local --volumes --remove-orphans || true
          fi
        fi

    - name: Prune Docker (images/containers/networks/volumes)
      shell: bash
      run: |
        if command -v docker >/dev/null 2>&1; then
          echo "Pruning Docker builder cache…"
          docker builder prune -af || true
          echo "Pruning Docker system (images, containers, networks)…"
          docker system prune -af || true
          echo "Pruning Docker volumes…"
          docker volume prune -f || true
          echo "Removing buildx cache dirs if present…"
          rm -rf ~/.cache/buildx ~/.local/share/buildx 2>/dev/null || true
        fi

    - name: Remove Python & test caches in workspace
      shell: bash
      run: |
        set -e
        echo "Removing Python/test caches from workspace…"
        find "${GITHUB_WORKSPACE}" -type d -name "__pycache__" -prune -exec rm -rf {} + 2>/dev/null || true
        find "${GITHUB_WORKSPACE}" -type d -name ".pytest_cache" -prune -exec rm -rf {} + 2>/dev/null || true
        find "${GITHUB_WORKSPACE}" -type d -name ".mypy_cache" -prune -exec rm -rf {} + 2>/dev/null || true
        find "${GITHUB_WORKSPACE}" -type d -name ".ruff_cache" -prune -exec rm -rf {} + 2>/dev/null || true
        # Common virtualenv / tox leftovers (only if present)
        rm -rf "${GITHUB_WORKSPACE}/.venv" "${GITHUB_WORKSPACE}/venv" "${GITHUB_WORKSPACE}/.tox" 2>/dev/null || true
        # Coverage + test result bundles if they exist (post upload)
        rm -rf "${GITHUB_WORKSPACE}/test-results" "${GITHUB_WORKSPACE}/.coverage" \
               "${GITHUB_WORKSPACE}/coverage.xml" 2>/dev/null || true

    - name: Clear user-level caches (pip/npm/tmp)
      shell: bash
      run: |
        echo "Clearing pip cache…"
        rm -rf ~/.cache/pip 2>/dev/null || true
        echo "Clearing pip wheelhouse (if any)…"
        rm -rf ~/.cache/pip-tools ~/.wheelhouse 2>/dev/null || true
        echo "Clearing npm cache (if any)…"
        rm -rf ~/.npm ~/.cache/npm 2>/dev/null || true
        echo "Clearing tmp dirs…"
        rm -rf /tmp/* 2>/dev/null || true

    - name: Trim Actions runner diagnostics (best-effort)
      shell: bash
      run: |
        # The original error referenced /home/runner/actions-runner/cached/_diag/*.log
        # On hosted runners this is usually accessible. Best-effort cleanup:
        TARGET="/home/runner/actions-runner/cached/_diag"
        if [ -d "$TARGET" ]; then
          echo "Trimming $TARGET logs…"
          find "$TARGET" -type f -name "*.log" -mtime +1 -delete 2>/dev/null || true
          # If logs are huge but you want to keep files, just truncate:
          find "$TARGET" -type f -name "*.log" -size +50M -exec sh -c 'true > "$1"' _ {} \; 2>/dev/null || true
        fi

    - name: Post-clean diagnostics (disk + inodes)
      shell: bash
      run: |
        echo "===== DISK USAGE AFTER (df -h) ====="
        df -h
        echo
        echo "===== INODE USAGE AFTER (df -ih) ====="
        df -ih || true
        echo
        echo "===== Largest dirs in workspace after (top 20) ====="
        du -x -h -d 2 "${GITHUB_WORKSPACE}" 2>/dev/null | sort -hr | head -n 20 || true
