<!-- Modal for progress -->
<div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="progressModalLabel">Processing</h5>
        </div>
        <div class="modal-body">
          <div class="progress" role="progressbar" aria-label="Processing progress" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%" id="progressBar"></div>
          </div>
          <p id="progressText" class="mt-2 text-center">0%</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    function startProgressPolling() {
        const progressInterval = setInterval(function() {
            fetch("{% url 'progress_status' %}", {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                const progress = data.progress;

                if (progress === -1) {
                    clearInterval(progressInterval);
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressBar.style.width = '100%';
                    progressText.textContent = '❌ Error: ' + (data.error || 'An unknown error occurred.');
                    return;
                }

                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    progressModal.hide();  // Optionally hide modal when done
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error fetching progress:', error);
                progressText.textContent = '⚠️ Failed to fetch progress';
                progressBar.classList.add('bg-warning');
                progressBar.style.width = '100%';
            });
        }, 5000);
    }

    document.querySelector("form").addEventListener("submit", function(event) {
        progressModal.show();
        startProgressPolling();
    }, true);
</script>