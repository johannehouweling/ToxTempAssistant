<!-- Modal for progress -->
<div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="progressModalLabel">Processing</h5>
        </div>
        <div class="modal-body">
          <div class="progress" role="progressbar" aria-label="Processing progress" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%" id="progressBar"></div>
          </div>
          <p id="progressText" class="mt-2 text-center">0%</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Assume these elements are present in your template:
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // Function to start polling the progress endpoint
    function startProgressPolling() {
        const progressInterval = setInterval(function() {
            fetch("{% url 'progress_status' %}", {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                const progress = data.progress;
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            })
            .catch(error => console.error('Error fetching progress:', error));
        }, 1000);
    }

    // Attach an event listener in capture phase that only shows the modal and starts polling.
    // By setting the third argument to true, this handler runs during the capturing phase.
    document.querySelector("form").addEventListener("submit", function(event) {
        // Do not call event.preventDefault(), so the other listener gets the event.
        progressModal.show();  // Show the modal immediately.
        startProgressPolling();  // Start polling for progress.
        // Note: This handler does not submit the form via AJAXâ€”the other handler will handle submission.
    }, true);
</script>