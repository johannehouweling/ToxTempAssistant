{% extends "base.html" %}

{% block title %}Home Page{% endblock %}

{% block content %}
{% load django_bootstrap5 %}
{% load extras %}
<style>
  .btn-indigo {
      background-color: #6610f2; /* Bootstrap indigo color */
      border-color: #6610f2; /* Match border color to background */
      color: white;
  }
  .btn-indigo:hover {
      background-color: #2c1a4d; /* Darker shade for hover effect */
      border-color: #2c1a4d; /* Match border color on hover */
      color: white;
  }
  .btn-outline-indigo {
      color: #6610f2; /* Text color for outline button */
      border-color: #6610f2; /* Border color */
  }
  .btn-outline-indigo:hover {
      background-color: #6610f2; /* Background color on hover */
      color: white; /* Text color on hover */
  }
</style>
<h1> Test method description of {{ assay.title }}</h1>
<div class"container-fluid" >
    <div class="row" style="height: 100%;">
        <!-- Scrollspy Sidebar -->
        <div class="col-4">
            <div style="position: sticky; top: 0; height: 70vh; overflow-y: auto;">
                <nav id="navbar-questions" class="flex-column align-items-stretch border-end">
                    <nav class="nav nav-pills flex-column">
                        {% for section in sections %}
                            <a class="nav-link" href="#section-{{ section.id }}">{{ section.title }}</a>
                            <nav class="nav nav-pills flex-column">
                                {% for subsection in section.subsections.all %}
                                    <a class="nav-link ms-3 my-1" href="#subsection-{{ subsection.id }}">{{ subsection.title }}</a>
                                {% endfor %}
                            </nav>
                        {% endfor %}
                    </nav>
                </nav>
            </div>
            <!-- Back Button -->
            <div class="mt-3">
                {% bootstrap_button button_type="link" content="Back" href=back_url button_class="btn-outline-danger"  %}
            </div>
        </div>
            

        <!-- Content Area for Questions -->
        <div class="col-8" style="height: 90%;">
            <form method="post" action="{{action}}" novalidate>
                {% csrf_token %}
                {{ form.non_field_errors }}
                <div id="question-content" data-bs-spy="scroll" data-bs-target="#navbar-questions" data-bs-smooth-scroll="true" class="scrollspy-example-2" tabindex="0" style="height: 70vh; overflow-y: auto;">
                    {% for section in sections %}
                        <div id="section-{{ section.id }}" class="mt-5">
                            <h4>{{ section.title }}</h4>
                            {% for subsection in section.subsections.all %}
                                <div id="subsection-{{ subsection.id }}" class="mt-3">
                                    <h5>{{ subsection.title }}</h5>
                                    {% for question in subsection.questions.all %}
                                        <div class="mb-3">
                                            {% comment %} <label for="id_question_{{ question.id }}">{{ question.question_text }}</label> {% endcomment %}
                                            {% with quest_num='question_'|add_asstring:question.id %}
                                            {% bootstrap_field form|form_field:quest_num placeholder="" %}
                                            {% endwith%} 
                                        </div>
                                        <button type="button" class="btn btn-outline-indigo" id="openModalButton"
                                                data-bs-toggle="modal"
                                                data-bs-target="#versionHistoryModal"
                                                data-assay-id="{{ assay.id }}"
                                                data-question-id="{{question.id}}">
                                            History
                                        </button>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Submit Button -->
                <div class="mt-3">
                    {% bootstrap_button button_type="submit" content="Save" %}
                    <div class="btn-group">
                      <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Export
                      </button>
                      <ul class="dropdown-menu">
                        {% with id=assay.id %}
                        <li><a class="dropdown-item" href="{{export_json_url}}">JSON</a></li>
                        <li><a class="dropdown-item" href="{{export_md_url}}">MD</a></li>
                        <li><a class="dropdown-item" href="{{export_pdf_url}}">PDF</a></li>
                        <li><a class="dropdown-item" href="{{export_xml_url}}">XML</a></li>
                        <li><a class="dropdown-item" href="{{export_docx_url}}">DOCX</a></li>
                        <li><a class="dropdown-item" href="{{export_html_url}}">HTML</a></li>
                        {% endwith %}
                      </ul>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal fade" id="versionHistoryModal" tabindex="-1" aria-labelledby="versionHistoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="versionHistoryLabel">Version History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Content will be loaded dynamically via AJAX -->
          <div id="modal-body-content">
            <p>Loading version history...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

<!-- Scrollspy Auto Scroll Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Get the modal element and modal body
      var modal = document.getElementById('versionHistoryModal');
      var modalBody = document.getElementById('modal-body-content');
  
      // Add event listener to the modal to fire when it is about to be shown
      modal.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = event.relatedTarget;
        // Extract model_id, assay_id, and question_id from data-* attributes
        var modelId = button.getAttribute('data-model-id');
        var assayId = button.getAttribute('data-assay-id');
        var questionId = button.getAttribute('data-question-id');
        console.log(questionId)
        // Clear previous content in modal
        modalBody.innerHTML = '<p>Loading version history...</p>';
        if (questionId) {
        // Fetch the version history with assay_id and question_id as query parameters
        fetch(`question/${questionId}/version-history/`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text(); // Get response as HTML
          })
          .then(data => {
            // Insert the version history HTML into the modal body
            modalBody.innerHTML = data;
          })
          .catch(error => {
            modalBody.innerHTML = '<p>Error loading version history. Please save the answers at least once for the version history to be displayed.</p>';
          });
        }
      });
    });
  </script>
{% include "error_handling.html" %}
{% endblock %}

