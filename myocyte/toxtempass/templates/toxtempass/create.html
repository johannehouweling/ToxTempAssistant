{% extends "base.html" %}

{% block title %}Home Page{% endblock %}

{% block content %}
{% load django_bootstrap5 %}
<h2>{{title}}</h2>
 <!-- action defines where ajax sends the post to, novalidate to use bootstrap validation markup --> 
<form method="post" action="{{action}}" novalidate>
    <div id="non-field-errors"></div>
    {% csrf_token %}
    {% bootstrap_form form layout='floating'%}
    {% bootstrap_button button_type="submit" content="Save" button_class="btn-primary" %}
    {% bootstrap_button button_type="link" content="Back" href=back_url button_class="btn-outline-danger" %}
</form>
{% include "error_handling.html" %}

<script>
// Consent checkbox acknowledgment tracking
document.addEventListener('DOMContentLoaded', function() {
    const consentCheckbox = document.getElementById('id_share_files_for_development');
    const acknowledgedField = document.getElementById('id_consent_acknowledged');
    const form = document.querySelector('form');
    
    if (consentCheckbox && acknowledgedField && form) {
        // Track if user has interacted with the consent checkbox
        let hasInteracted = false;
        
        consentCheckbox.addEventListener('change', function() {
            hasInteracted = true;
            acknowledgedField.value = 'true';
        });
        
        // On form submission, check if user has acknowledged
        form.addEventListener('submit', function(e) {
            if (!hasInteracted) {
                e.preventDefault();
                alert('Please acknowledge your choice regarding file sharing by checking or unchecking the box.');
                consentCheckbox.focus();
                // Highlight the field
                const fieldContainer = consentCheckbox.closest('.mb-3');
                if (fieldContainer) {
                    fieldContainer.classList.add('border', 'border-danger', 'p-2', 'rounded');
                    setTimeout(() => {
                        fieldContainer.classList.remove('border', 'border-danger', 'p-2', 'rounded');
                    }, 3000);
                }
            }
        });
    }
    
    // Auto-start tour on create_assay page
    const urlName = document.body.getAttribute('data-url-name');
    const config = window.ToxTempConfig || {};
    const onboardingHelp = config.user_onboarding_help || {};
    
    // Auto-start tour if this page has tour steps defined
    if (urlName && onboardingHelp[urlName] && onboardingHelp[urlName].length > 0) {
        if (typeof window.startOnboarding === "function") {
            setTimeout(() => window.startOnboarding(), 300); // Small delay to ensure page is fully loaded
        }
    }
});

// Set flag to continue tour on next page when form is submitted
document.querySelector('form').addEventListener('submit', function(e) {
    const urlName = document.body.getAttribute('data-url-name');
    if (urlName === 'create_assay' || urlName === 'update_assay') {
        localStorage.setItem('continueTourTo', 'add_new');
    }
});
</script>
{%endblock%}
