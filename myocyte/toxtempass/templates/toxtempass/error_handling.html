<script>
var response = {}
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');

    // Inline progress bar elements
    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressFilename = document.getElementById('uploadProgressFilename');

    // Modal progress elements
    const uploadModalEl = document.getElementById('uploadProgressModal');
    let uploadModal = null;
    let modalProgressBar = null;
    let modalProgressFilename = null;

    // Initialize Bootstrap modal instance if modal element exists
    if (uploadModalEl && window.bootstrap && window.bootstrap.Modal) {
        uploadModal = new bootstrap.Modal(uploadModalEl, {backdrop: 'static', keyboard: false});
        modalProgressBar = uploadModalEl.querySelector('#uploadProgressBarModal');
        modalProgressFilename = uploadModalEl.querySelector('#uploadProgressFilenameModal');
    }

    const demoLockedModalEl = document.getElementById('demoLockedModal');
    const demoLockedModal = demoLockedModalEl && window.bootstrap && window.bootstrap.Modal
        ? new bootstrap.Modal(demoLockedModalEl)
        : null;

    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the form from submitting the default way
        const formData = new FormData(form); // Create FormData object for handling file uploads
        const filesInForm = formData.getAll('files');

        // Clear previous errors
        form.querySelectorAll('.invalid-feedback').forEach(function(error) {
            error.remove();
        });
        form.querySelectorAll('.is-invalid').forEach(function(input) {
            input.classList.remove('is-invalid', 'rounded-end');
        });

        const request = new XMLHttpRequest();
        request.open(form.getAttribute('method'), form.getAttribute('action'));

        // Show modal if files exist and modal available, else use inline
        if (filesInForm.length > 0) {
            if (uploadModal) {
                // reset modal progress bar and filename text
                modalProgressBar.style.width = '0%';
                modalProgressBar.setAttribute('aria-valuenow', 0);
                modalProgressBar.textContent = '0%';
                modalProgressFilename.textContent = '';

                uploadModal.show();
            } else if (progressContainer && progressBar) {
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.textContent = '0%';
                if (progressFilename) {
                    progressFilename.textContent = '';
                }
            }
        }

        // Upload progress handler
        request.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);

                if (uploadModal) {
                    modalProgressBar.style.width = percentComplete + '%';
                    modalProgressBar.setAttribute('aria-valuenow', percentComplete);
                    // Replace percentage text with file count text (e.g. "1/2")
                    modalProgressBar.textContent = '1/' + filesInForm.length;

                    // Keep showing the filenames below the progress bar
                    if (filesInForm.length > 0) {
                        let fileList = [];
                        for (const file of filesInForm) {
                            fileList.push(file.name);
                        }
                        if (fileList.length > 0) {
                            modalProgressFilename.textContent = 'Uploading: ' + fileList.join(', ');
                        }
                    }
                } else if (progressContainer && progressBar) {
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                    // Replace percentage text with file count text (e.g. "1/2")
                    progressBar.textContent = '1/' + filesInForm.length;

                    if (progressFilename) {
                        if (filesInForm.length > 0) {
                            let fileList = [];
                            for (const file of filesInForm) {
                                fileList.push(file.name);
                            }
                            if (fileList.length > 0) {
                                progressFilename.textContent = 'Uploading: ' + fileList.join(', ');
                            }
                        }
                    }
                }
            }
        });

        // Set up callback for success or error
        request.onload = function() {
            if (request.status >= 200 && request.status < 501) {
                response = JSON.parse(request.responseText);

                function hideModalAndMoveFocus() {
                    uploadModal.hide();
                    // Move focus to the form submit button or the form itself after hiding modal
                    const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                    if (submitBtn) {
                        submitBtn.focus();
                    } else {
                        form.focus();
                    }
                }

                if (response.success) {
                    // Handle success (e.g., redirect, display a success message, etc.)
                    if (uploadModal) {
                        modalProgressBar.style.width = '100%';
                        // Replace completion text with file count text
                        modalProgressBar.textContent = '1/' + filesInForm.length + ' complete';
                        setTimeout(() => { hideModalAndMoveFocus(); }, 500);
                    } else if (progressContainer && progressBar) {
                        progressBar.style.width = '100%';
                        // Replace completion text with file count text
                        progressBar.textContent = '1/' + filesInForm.length + ' complete';
                    }
                    if (filesInForm.length > 0) {
                        if (uploadModal) {
                            modalProgressFilename.textContent =
                                'Uploaded: ' + filesInForm.map(f => f.name).join(', ');
                        } else if (progressFilename) {
                            progressFilename.textContent =
                                'Uploaded: ' + filesInForm.map(f => f.name).join(', ');
                        }
                    }
                    window.location.href = response.redirect_url;
                } else {
                    // Handle form errors
                    for (const field in response.errors) {
                        const errors = response.errors[field];

                        // Handle QuantityField split field names
                        const buttonFields = form.querySelectorAll(`[name^=${field}_btn]`);
                        const lastButton = buttonFields[buttonFields.length - 1];
                        const inputField = form.querySelector(`[name=${field}]`);

                        if (inputField) {
                            inputField.classList.add('is-invalid');
                        }

                        if (buttonFields.length > 0) {
                            buttonFields.forEach(function(button) {
                                button.classList.add('is-invalid');
                            });
                            lastButton.classList.add('rounded-end');
                            const errorDiv = document.createElement('div');
                            errorDiv.classList.add('invalid-feedback');
                            errorDiv.innerHTML = errors.join('<br>');
                            lastButton.insertAdjacentElement('afterend', errorDiv);
                        } else if (inputField) {
                            const errorDiv = document.createElement('div');
                            errorDiv.classList.add('invalid-feedback');
                            errorDiv.innerHTML = errors.join('<br>');
                            inputField.insertAdjacentElement('afterend', errorDiv);
                        }
                    }

                    // Handle non-field errors
                    if (response.errors.__all__) {
                        const nonFieldErrorsContainer = document.getElementById('non-field-errors');
                        nonFieldErrorsContainer.innerHTML = `<div class="alert alert-danger">${response.errors.__all__.join('<br>')}</div>`;
                        if (demoLockedModal && response.errors.__all__.some(msg => msg.includes('Demo assays cannot be regenerated'))) {
                            demoLockedModal.show();
                        }
                    }

                    // Hide and reset progress bars
                    if (uploadModal) {
                        setTimeout(() => {
                            hideModalAndMoveFocus();
                        }, 500);
                        modalProgressBar.style.width = '0%';
                        modalProgressBar.setAttribute('aria-valuenow', 0);
                        modalProgressBar.textContent = '0%';
                        modalProgressFilename.textContent = '';
                    } else if (progressContainer && progressBar) {
                        progressContainer.style.display = 'none';
                        progressBar.style.width = '0%';
                        progressBar.setAttribute('aria-valuenow', 0);
                        progressBar.textContent = '0%';
                        if (progressFilename) {
                            progressFilename.textContent = '';
                        }
                    }
                }
            } else {
                alert('An unexpected error occurred. Please try again.');
                if (uploadModal) {
                    uploadModal.hide();
                    modalProgressBar.style.width = '0%';
                    modalProgressBar.setAttribute('aria-valuenow', 0);
                    modalProgressBar.textContent = '0%';
                    modalProgressFilename.textContent = '';
                } else if (progressContainer && progressBar) {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', 0);
                    progressBar.textContent = '0%';
                    if (progressFilename) {
                        progressFilename.textContent = '';
                    }
                }
            }
        };

        request.onerror = function() {
            alert('An unexpected error occurred. Please try again.');
            if (uploadModal) {
                uploadModal.hide();
                modalProgressBar.style.width = '0%';
                modalProgressBar.setAttribute('aria-valuenow', 0);
                modalProgressBar.textContent = '0%';
                modalProgressFilename.textContent = '';
            } else if (progressContainer && progressBar) {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.textContent = '0%';
                if (progressFilename) {
                    progressFilename.textContent = '';
                }
            }
        };

        // Send the form data
        request.send(formData);
    });
});
</script>
